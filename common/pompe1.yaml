logger:
  level: WARN
  logs:
    pump: DEBUG 
    sensor: WARN
    number: WARN
    text_sensor: WARN
    component: ERROR
    main: ERROR
    api: WARN
    wifi: WARN
    switch: WARN
    select: WARN
    output: WARN
    interval: INFO
#####################################
#            VARIABLES              #
#####################################
# Globales pour la gestion de la pompe 1
globals:
  - id: ${pump_id}_reservoir_capacity
    type: float
    restore_value: true
    initial_value: '1000.0'
  # Activation de la pompe
  - id: ${pump_id}_enabled
    type: bool
    restore_value: true
    initial_value: 'true'
  # QuantitÃ© quotidienne Ã  distribuer (ml)
  - id: ${pump_id}_daily_quantity
    type: float
    restore_value: true
    initial_value: '50.0'
  - id: ${pump_id}_daily_quantity_computed
    type: float
    restore_value: false
    initial_value: '0.0'
  # Mode de distribution
  # 0: Dose manuelle, 1: 24 doses (chaque heure), 2: 12 doses (toutes les 2h)
  # (Les modes 3 et 4 sont implÃ©mentÃ©s plus bas)
  - id: ${pump_id}_distribution_mode
    type: int
    restore_value: true
    initial_value: '0'
  # Pour le mode manuel : heure et minute de la dose (non utilisÃ©, conservÃ© pour compatibilitÃ©)
  - id: ${pump_id}_dose_time_hour
    type: int
    restore_value: true
    initial_value: '12'
  - id: ${pump_id}_dose_time_minute
    type: int
    restore_value: true
    initial_value: '0'
  # Pour les modes horaires : minute dâ€™offset (exemple : dose Ã  Xh10)
  - id: ${pump_id}_dose_offset_minute
    type: int
    restore_value: true
    initial_value: '10'
  # Volume restant dans le Falcon (ml)
  - id: ${pump_id}_volume_remaining
    type: float
    restore_value: true
    initial_value: '1000.0'
  # Indique si la pompe est destinÃ©e Ã  lâ€™alimentation (pour dÃ©clencher dâ€™autres scripts)
  - id: ${pump_id}_is_alimentation
    type: bool
    restore_value: true
    initial_value: 'false'
  # Calibration
  - id: ${pump_id}_last_calibration
    type: long
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_last_calibration_reminder
    type: long
    restore_value: false
    initial_value: '0'

  - id: ${pump_id}_calibration_frequency
    type: int
    restore_value: true
    initial_value: '30'   # FrÃ©quence de rappel en jours (modifiable)
  - id: ${pump_id}_calibration_value
    type: float
    restore_value: true
    initial_value: '5.0'  # Volume dÃ©livrÃ© lors du run de calibration (en ml)
  - id: ${pump_id}_calibration_steps
    type: int
    restore_value: true
    initial_value: '120000'  # Nombre de pas pendant la calibration (environ 2 minutes de fonctionnement)
  - id: ${pump_id}_calibration_factor
    type: float
    restore_value: true
    initial_value: '0.0098'  # Facteur = calibration_value / calibration_steps (ml par pas)
  - id: ${pump_id}_calibration_volume_estimate
    type: float
    restore_value: false
    initial_value: '0.0'
  - id: ${pump_id}_calibration_volume_adjusted
    type: bool
    restore_value: false
    initial_value: 'false'
  # Variable utilisÃ©e pour stocker temporairement le volume Ã  dose (en ml) lors dâ€™un dosage
  - id: ${pump_id}_dose_ml
    type: float
    restore_value: false
    initial_value: '0.0'
  
  # Mode 3 - PÃ©riodes personnalisÃ©es (1 Ã  6)
  - id: ${pump_id}_period1_start_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period1_start_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period1_end_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period1_end_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period1_doses
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period2_start_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period2_start_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period2_end_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period2_end_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period2_doses
    type: int
    restore_value: true
    initial_value: '0'

  - id: ${pump_id}_period3_start_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period3_start_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period3_end_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period3_end_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period3_doses
    type: int
    restore_value: true
    initial_value: '0'

  - id: ${pump_id}_period4_start_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period4_start_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period4_end_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period4_end_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period4_doses
    type: int
    restore_value: true
    initial_value: '0'

  - id: ${pump_id}_period5_start_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period5_start_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period5_end_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period5_end_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period5_doses
    type: int
    restore_value: true
    initial_value: '0'

  - id: ${pump_id}_period6_start_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period6_start_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period6_end_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period6_end_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_period6_doses
    type: int
    restore_value: true
    initial_value: '0'

  - id: ${pump_id}_period1_enabled
    type: bool
    restore_value: true
    initial_value: 'true'
  - id: ${pump_id}_period2_enabled
    type: bool
    restore_value: true
    initial_value: 'true'
  - id: ${pump_id}_period3_enabled
    type: bool
    restore_value: true
    initial_value: 'true'
  - id: ${pump_id}_period4_enabled
    type: bool
    restore_value: true
    initial_value: 'false'
  - id: ${pump_id}_period5_enabled
    type: bool
    restore_value: true
    initial_value: 'false'
  - id: ${pump_id}_period6_enabled
    type: bool
    restore_value: true
    initial_value: 'false'
  - id: ${pump_id}_active_periods
    type: int
    restore_value: true
    initial_value: '3'
  # Mode 4 - Minuteur : doses programmÃ©es individuellement pour 12 doses
  - id: ${pump_id}_minute_dose_1_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_1_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_1_quantity
    type: float
    restore_value: true
    initial_value: '0.0'
  - id: ${pump_id}_minute_dose_2_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_2_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_2_quantity
    type: float
    restore_value: true
    initial_value: '0.0'
  - id: ${pump_id}_minute_dose_3_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_3_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_3_quantity
    type: float
    restore_value: true
    initial_value: '0.0'
  - id: ${pump_id}_minute_dose_4_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_4_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_4_quantity
    type: float
    restore_value: true
    initial_value: '0.0'
  - id: ${pump_id}_minute_dose_5_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_5_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_5_quantity
    type: float
    restore_value: true
    initial_value: '0.0'
  - id: ${pump_id}_minute_dose_6_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_6_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_6_quantity
    type: float
    restore_value: true
    initial_value: '0.0'
  - id: ${pump_id}_minute_dose_7_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_7_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_7_quantity
    type: float
    restore_value: true
    initial_value: '0.0'
  - id: ${pump_id}_minute_dose_8_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_8_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_8_quantity
    type: float
    restore_value: true
    initial_value: '0.0'
  - id: ${pump_id}_minute_dose_9_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_9_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_9_quantity
    type: float
    restore_value: true
    initial_value: '0.0'
  - id: ${pump_id}_minute_dose_10_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_10_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_10_quantity
    type: float
    restore_value: true
    initial_value: '0.0'
  - id: ${pump_id}_minute_dose_11_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_11_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_11_quantity
    type: float
    restore_value: true
    initial_value: '0.0'
  - id: ${pump_id}_minute_dose_12_hour
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_12_minute
    type: int
    restore_value: true
    initial_value: '0'
  - id: ${pump_id}_minute_dose_12_quantity
    type: float
    restore_value: true
    initial_value: '0.0'
  - id: ${pump_id}_product_name
    type: std::string
    restore_value: true
    initial_value: '"Sans nom"'
  # Volume total utilisÃ© par la pompe (y compris tests, amorÃ§age, etc.)
  - id: ${pump_id}_used_today
    type: float
    restore_value: true
    initial_value: '0.0'
  
  # Volume effectivement injectÃ© dans lâ€™aquarium (hors calibration/amorÃ§age)
  - id: ${pump_id}_distributed_today
    type: float
    restore_value: true
    initial_value: '0.0'
  - id: ${pump_id}_minuteur_ready
    type: bool
    restore_value: false
    initial_value: 'false'
  - id: ${pump_id}_last_dose_log
    type: std::string
    restore_value: true
    initial_value: '"Jamais"'
  # Mode de test 
  - id: ${pump_id}_test_mode
    type: bool
    restore_value: true
    initial_value: 'false'
  # Vitesse de la pompe (0=lent, 1=moyen, 2=rapide)
  - id: ${pump_id}_speed_level
    type: int
    restore_value: true
    initial_value: '1'
  - id: ${pump_id}_manual_dose_active
    type: bool
    restore_value: false
    initial_value: 'false'
  - id: ${pump_id}_abort_requested
    type: bool
    restore_value: false
    initial_value: 'false'
  - id: ${pump_id}_steps_to_run
    type: int
    restore_value: false
    initial_value: '0'
  - id: ${pump_id}_steps_remaining
    type: int
    restore_value: false
    initial_value: '0'
  - id: ${pump_id}_current_chunk
    type: int
    restore_value: false
    initial_value: '0'
  # Taille maximale d'un chunk de dÃ©placement
  - id: ${pump_id}_chunk_size
    type: int
    restore_value: false
    initial_value: '600'
  # Position cible du mouvement en cours
  - id: ${pump_id}_chunk_target
    type: int
    restore_value: false
    initial_value: '0'
  - id: ${pump_id}_priming_steps_remaining
    type: int
    restore_value: false
    initial_value: '0'
  - id: ${pump_id}_calibration_steps_remaining
    type: int
    restore_value: false
    initial_value: '0'
  - id: ${pump_id}_calibration_steps_done
    type: int
    restore_value: false
    initial_value: '0'
  # Sauvegarde temporaire de la vitesse du stepper pour amorÃ§age
  - id: ${pump_id}_stepper_speed_saved
    type: int
    restore_value: false
    initial_value: '900'
  # Vitesse actuellement appliquÃ©e au moteur
  - id: ${pump_id}_current_speed
    type: int
    restore_value: false
    initial_value: '900'
  # Position cible utilisÃ©e pour l'amorÃ§age rapide
  - id: ${pump_id}_fast_target
    type: int
    restore_value: false
    initial_value: '0'
  # Position cible utilisÃ©e pour la calibration
  - id: ${pump_id}_calibration_target
    type: int
    restore_value: false
    initial_value: '0'
#####################################
#         sensor         #
#####################################
sensor:
  - platform: template
    name: "Volume quotidien ${pump_name} (ml)"
    id: ${pump_id}_daily_quantity_sensor
    update_interval: 10s
    unit_of_measurement: "ml"
    entity_category: diagnostic
    lambda: |-
      if (id(${pump_id}_distribution_mode) == 4)
        return id(${pump_id}_daily_quantity_computed);
      else
        return id(${pump_id}_daily_quantity);
    web_server:
      sorting_group_id: sorting_group_general
  - platform: template
    name: "${pump_name} - Volume utilisÃ© (aujourd'hui)"
    id: ${pump_id}_used_today_sensor
    unit_of_measurement: "ml"
    accuracy_decimals: 1
    lambda: |-
      return id(${pump_id}_used_today);
    update_interval: 10s
    entity_category: diagnostic
    web_server:
      sorting_group_id: sorting_group_general

  - platform: template
    name: "${pump_name} - Volume restant (ml)"
    id: ${pump_id}_volume_remaining_sensor
    unit_of_measurement: "ml"
    accuracy_decimals: 0
    lambda: |-
      return id(${pump_id}_volume_remaining);
    update_interval: 10s

  - platform: template
    name: "${pump_name} - Volume distribuÃ© (aujourd'hui)"
    id: ${pump_id}_distributed_today_sensor
    unit_of_measurement: "ml"
    accuracy_decimals: 1
    lambda: |-
      return id(${pump_id}_distributed_today);
    update_interval: 10s
    entity_category: diagnostic
    web_server:
      sorting_group_id: sorting_group_general
# ou diagnostic, misc, etc.
text:
  - platform: template
    name: "${pump_name} - Nom du produit"
    id: ${pump_id}_product_name_text
    mode: text
    entity_category: config
    lambda: |-
      return optional<std::string>(id(${pump_id}_product_name));
    set_action:
      - lambda: |-
          id(${pump_id}_product_name) = x;
          id(${pump_id}_product_name_text).publish_state(x);
          ESP_LOGD("pump", "Nom du produit mis Ã  jour: %s", x.c_str());
text_sensor:
  # Titres de regroupement visuels (faux sensors repliables)

  - platform: template
    name: "ğŸ•’ Mode 0 â€“ Dose manuelle"
    lambda: |-
      return optional<std::string>(" ");
    entity_category: diagnostic
    web_server:
      sorting_group_id: sorting_group_mode0

  - platform: template
    name: "ğŸ•’ Mode 1 â€“ 24 doses / jour"
    lambda: |-
      return optional<std::string>(" ");
    entity_category: diagnostic
    web_server:
      sorting_group_id: sorting_group_mode1

  - platform: template
    name: "ğŸ•’ Mode 2 â€“ 12 doses / jour"
    lambda: |-
      return optional<std::string>(" ");
    entity_category: diagnostic
    web_server:
      sorting_group_id: sorting_group_mode2

  - platform: template
    name: "ğŸ—“ï¸ Mode 3 â€“ PÃ©riodes personnalisÃ©es"
    lambda: |-
      return optional<std::string>(" ");
    entity_category: diagnostic
    web_server:
      sorting_group_id: sorting_group_mode3

  - platform: template
    name: "â±ï¸ Mode 4 â€“ Minuteurs"
    lambda: |-
      return optional<std::string>(" ");
    entity_category: diagnostic
    web_server:
      sorting_group_id: sorting_group_mode4

  - platform: template
    name: "ğŸ”§ Calibration & Maintenance"
    lambda: |-
      return optional<std::string>(" ");
    entity_category: diagnostic
    web_server:
      sorting_group_id: sorting_group_calibration

  # Affichage du nom du produit distribuÃ©
  - platform: template
    name: "${pump_name} - Produit distribuÃ©"
    lambda: |-
      return optional<std::string>(id(${pump_id}_product_name));
    entity_category: config
  - platform: template
    name: "${pump_name} - DerniÃ¨re dose"
    lambda: |-
      return optional<std::string>(id(${pump_id}_last_dose_log));
    update_interval: never
    entity_category: diagnostic
    icon: mdi:clock
    id: ${pump_id}_last_dose_text
    web_server:
      sorting_group_id: sorting_group_general
  - platform: template
    name: "${pump_name} - Statut"
    id: ${pump_id}_status
    lambda: |-
      return optional<std::string>("PrÃªt");
    update_interval: never
    entity_category: diagnostic
    web_server:
      sorting_group_id: sorting_group_mode0
  # --- Section wifi_info dÃ©placÃ©e Ã  la fin du bloc text_sensor ---
  - platform: wifi_info
    ip_address:
      name: "Adresse IP ESP32"
    mac_address:
      name: "Adresse MAC"
    bssid:
      name: "WiFi BSSID"
    ssid:
      name: "WiFi SSID"
#####################################
#            MOTEUR PAS Ã€ PAS        #
#####################################
# Utilisation du composant stepper ULN2003
stepper:
  - platform: uln2003
    id: ${pump_id}_stepper
    pin_a: ${pump_pin_a}
    pin_b: ${pump_pin_b}
    pin_c: ${pump_pin_c}
    pin_d: ${pump_pin_d}
    step_mode: HALF_STEP
    max_speed: 1000 steps/s
    acceleration: 800 steps/s^2
    sleep_when_done: true

esphome:
  on_boot:
    priority: -100
    then:
      - lambda: |-
          id(${pump_id}_stepper).set_sleep_when_done(true);
          id(${pump_id}_stepper).set_target(id(${pump_id}_stepper).current_position);
      - switch.turn_off: ${pump_id}_motor_power

################################################
#     COMPOSANTS NUMBER & SELECT (UI)          #
#     Titres de regroupement ajoutÃ©s
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘   PARAMÃˆTRES GÃ‰NÃ‰RAUX (TOUS MODES)  â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
number:
  # -------------------------------
  #  PUMP1_calibration
  # -------------------------------
  - platform: template
    name: "${pump_name} - Volume mesurÃ© (ml)"
    id: ${pump_id}_calibration_value_num
    icon: mdi:beaker-check
    min_value: 0.0
    max_value: 25.0
    step: 0.1
    lambda: |-
      return id(${pump_id}_calibration_value);
    set_action:
      - lambda: |-
          id(${pump_id}_calibration_value) = x;
          id(${pump_id}_calibration_value_num).publish_state(x);
          ESP_LOGD("pump", "Nouveau volume mesurÃ© pour calibration : %.2f ml", id(${pump_id}_calibration_value));
    web_server:
      sorting_group_id: sorting_group_calibration
  # -------------------------------
  #  PUMP1_DAILY_QUANTITY
  # -------------------------------
  - platform: template
    name: "${pump_name} - Volume quotidien (ml)"
    id: ${pump_id}_daily_quantity_num
    icon: mdi:beaker
    min_value: 0
    max_value: 500
    step: 1
    lambda: |-
      // Retourne la valeur actuelle
      return id(${pump_id}_daily_quantity);
    set_action:
      - lambda: |-
          id(${pump_id}_daily_quantity) = x;
          id(${pump_id}_daily_quantity_num).publish_state(x);
          ESP_LOGD("pump", "Nouveau volume quotidien: %.1f ml", id(${pump_id}_daily_quantity));
      - script.execute: update_computed_daily_quantity
      - script.execute: refresh_daily_quantity_sensor
    web_server:
      sorting_group_id: sorting_group_mode0
  - platform: template
    name: "${pump_name} - CapacitÃ© rÃ©servoir (ml)"
    id: ${pump_id}_reservoir_capacity_num
    icon: mdi:bottle-tonic
    min_value: 100
    max_value: 5000
    step: 10
    lambda: |-
      return id(${pump_id}_reservoir_capacity);
    set_action:
      - lambda: |-
          id(${pump_id}_reservoir_capacity) = x;
          id(${pump_id}_reservoir_capacity_num).publish_state(x);
          ESP_LOGI("pump", "CapacitÃ© du rÃ©servoir mise Ã  jour: %.0f ml", x);
  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘   MODE 1 - RÃ©partition sur 24 doses    â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # -------------------------------
  #  PUMP1_DOSE_OFFSET_MINUTE
  # -------------------------------
  - platform: template
    name: "${pump_name} - Offset minute"
    id: ${pump_id}_dose_offset_minute_num
    icon: mdi:timer
    min_value: 0
    max_value: 59
    step: 1
    lambda: |-
      return id(${pump_id}_dose_offset_minute);
    set_action:
      - lambda: |-
          id(${pump_id}_dose_offset_minute) = (int)x;
          id(${pump_id}_dose_offset_minute_num).publish_state(x);
          ESP_LOGD("pump", "Nouvel offset minute: %d", id(${pump_id}_dose_offset_minute));
    web_server:
      sorting_group_id: sorting_group_mode1

  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘   MODE 3 - RÃ©partition sur pÃ©riodes (1-6) â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # -------------------------------------
  #  PERIODES PERSONNALISÃ‰ES (1 Ã€ 6)
  # -------------------------------------
# Pour chaque pÃ©riode, on dÃ©clare Start Hour, Start Minute,
# End Hour, End Minute et Doses
# PÃ‰RIODE 1
  - platform: template
    name: "PÃ©riode 1 - Start Hour"
    id: ${pump_id}_period1_start_hour_num
    icon: mdi:clock-start
    min_value: 0
    max_value: 23
    step: 1
    lambda: |-
      return id(${pump_id}_period1_start_hour);
    set_action:
      - lambda: |-
          id(${pump_id}_period1_start_hour) = (int)x;
          id(${pump_id}_period1_start_hour_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 1 - Start Hour = %d", id(${pump_id}_period1_start_hour));
    web_server:
      sorting_group_id: sorting_group_mode3

  - platform: template
    name: "PÃ©riode 1 - Start Minute"
    id: ${pump_id}_period1_start_minute_num
    icon: mdi:clock-start
    min_value: 0
    max_value: 59
    step: 1
    lambda: |-
      return id(${pump_id}_period1_start_minute);
    set_action:
      - lambda: |-
          id(${pump_id}_period1_start_minute) = (int)x;
          id(${pump_id}_period1_start_minute_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 1 - Start Minute = %d", id(${pump_id}_period1_start_minute));
    web_server:
      sorting_group_id: sorting_group_mode3

  - platform: template
    name: "PÃ©riode 1 - End Hour"
    id: ${pump_id}_period1_end_hour_num
    icon: mdi:clock-end
    min_value: 0
    max_value: 23
    step: 1
    lambda: |-
      return id(${pump_id}_period1_end_hour);
    set_action:
      - lambda: |-
          id(${pump_id}_period1_end_hour) = (int)x;
          id(${pump_id}_period1_end_hour_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 1 - End Hour = %d", id(${pump_id}_period1_end_hour));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 1 - End Minute"
    id: ${pump_id}_period1_end_minute_num
    icon: mdi:clock-end
    min_value: 0
    max_value: 59
    step: 1
    lambda: |-
      return id(${pump_id}_period1_end_minute);
    set_action:
      - lambda: |-
          id(${pump_id}_period1_end_minute) = (int)x;
          id(${pump_id}_period1_end_minute_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 1 - End Minute = %d", id(${pump_id}_period1_end_minute));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 1 - Doses"
    id: ${pump_id}_period1_doses_num
    icon: mdi:counter
    min_value: 0
    max_value: 20
    step: 1
    lambda: |-
      return id(${pump_id}_period1_doses);
    set_action:
      - lambda: |-
          id(${pump_id}_period1_doses) = (int)x;
          id(${pump_id}_period1_doses_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 1 - Doses = %d", id(${pump_id}_period1_doses));
    web_server:
      sorting_group_id: sorting_group_mode3
# PÃ‰RIODE 2
  - platform: template
    name: "PÃ©riode 2 - Start Hour"
    id: ${pump_id}_period2_start_hour_num
    icon: mdi:clock-start
    min_value: 0
    max_value: 23
    step: 1
    lambda: |-
      return id(${pump_id}_period2_start_hour);
    set_action:
      - lambda: |-
          id(${pump_id}_period2_start_hour) = (int)x;
          id(${pump_id}_period2_start_hour_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 2 - Start Hour = %d", id(${pump_id}_period2_start_hour));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 2 - Start Minute"
    id: ${pump_id}_period2_start_minute_num
    icon: mdi:clock-start
    min_value: 0
    max_value: 59
    step: 1
    lambda: |-
      return id(${pump_id}_period2_start_minute);
    set_action:
      - lambda: |-
          id(${pump_id}_period2_start_minute) = (int)x;
          id(${pump_id}_period2_start_minute_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 2 - Start Minute = %d", id(${pump_id}_period2_start_minute));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 2 - End Hour"
    id: ${pump_id}_period2_end_hour_num
    icon: mdi:clock-end
    min_value: 0
    max_value: 23
    step: 1
    lambda: |-
      return id(${pump_id}_period2_end_hour);
    set_action:
      - lambda: |-
          id(${pump_id}_period2_end_hour) = (int)x;
          id(${pump_id}_period2_end_hour_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 2 - End Hour = %d", id(${pump_id}_period2_end_hour));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 2 - End Minute"
    id: ${pump_id}_period2_end_minute_num
    icon: mdi:clock-end
    min_value: 0
    max_value: 59
    step: 1
    lambda: |-
      return id(${pump_id}_period2_end_minute);
    set_action:
      - lambda: |-
          id(${pump_id}_period2_end_minute) = (int)x;
          id(${pump_id}_period2_end_minute_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 2 - End Minute = %d", id(${pump_id}_period2_end_minute));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 2 - Doses"
    id: ${pump_id}_period2_doses_num
    icon: mdi:counter
    min_value: 0
    max_value: 20
    step: 1
    lambda: |-
      return id(${pump_id}_period2_doses);
    set_action:
      - lambda: |-
          id(${pump_id}_period2_doses) = (int)x;
          id(${pump_id}_period2_doses_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 2 - Doses = %d", id(${pump_id}_period2_doses));
    web_server:
      sorting_group_id: sorting_group_mode3
# PÃ‰RIODE 3
  - platform: template
    name: "PÃ©riode 3 - Start Hour"
    id: ${pump_id}_period3_start_hour_num
    icon: mdi:clock-start
    min_value: 0
    max_value: 23
    step: 1
    lambda: |-
      return id(${pump_id}_period3_start_hour);
    set_action:
      - lambda: |-
          id(${pump_id}_period3_start_hour) = (int)x;
          id(${pump_id}_period3_start_hour_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 3 - Start Hour = %d", id(${pump_id}_period3_start_hour));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 3 - Start Minute"
    id: ${pump_id}_period3_start_minute_num
    icon: mdi:clock-start
    min_value: 0
    max_value: 59
    step: 1
    lambda: |-
      return id(${pump_id}_period3_start_minute);
    set_action:
      - lambda: |-
          id(${pump_id}_period3_start_minute) = (int)x;
          id(${pump_id}_period3_start_minute_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 3 - Start Minute = %d", id(${pump_id}_period3_start_minute));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 3 - End Hour"
    id: ${pump_id}_period3_end_hour_num
    icon: mdi:clock-end
    min_value: 0
    max_value: 23
    step: 1
    lambda: |-
      return id(${pump_id}_period3_end_hour);
    set_action:
      - lambda: |-
          id(${pump_id}_period3_end_hour) = (int)x;
          id(${pump_id}_period3_end_hour_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 3 - End Hour = %d", id(${pump_id}_period3_end_hour));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 3 - End Minute"
    id: ${pump_id}_period3_end_minute_num
    icon: mdi:clock-end
    min_value: 0
    max_value: 59
    step: 1
    lambda: |-
      return id(${pump_id}_period3_end_minute);
    set_action:
      - lambda: |-
          id(${pump_id}_period3_end_minute) = (int)x;
          id(${pump_id}_period3_end_minute_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 3 - End Minute = %d", id(${pump_id}_period3_end_minute));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 3 - Doses"
    id: ${pump_id}_period3_doses_num
    icon: mdi:counter
    min_value: 0
    max_value: 20
    step: 1
    lambda: |-
      return id(${pump_id}_period3_doses);
    set_action:
      - lambda: |-
          id(${pump_id}_period3_doses) = (int)x;
          id(${pump_id}_period3_doses_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 3 - Doses = %d", id(${pump_id}_period3_doses));
    web_server:
      sorting_group_id: sorting_group_mode3      
# PÃ‰RIODE 4
  - platform: template
    name: "PÃ©riode 4 - Start Hour"
    id: ${pump_id}_period4_start_hour_num
    icon: mdi:clock-start
    min_value: 0
    max_value: 23
    step: 1
    lambda: |-
      return id(${pump_id}_period4_start_hour);
    set_action:
      - lambda: |-
          id(${pump_id}_period4_start_hour) = (int)x;
          id(${pump_id}_period4_start_hour_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 4 - Start Hour = %d", id(${pump_id}_period4_start_hour));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 4 - Start Minute"
    id: ${pump_id}_period4_start_minute_num
    icon: mdi:clock-start
    min_value: 0
    max_value: 59
    step: 1
    lambda: |-
      return id(${pump_id}_period4_start_minute);
    set_action:
      - lambda: |-
          id(${pump_id}_period4_start_minute) = (int)x;
          id(${pump_id}_period4_start_minute_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 4 - Start Minute = %d", id(${pump_id}_period4_start_minute));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 4 - End Hour"
    id: ${pump_id}_period4_end_hour_num
    icon: mdi:clock-end
    min_value: 0
    max_value: 23
    step: 1
    lambda: |-
      return id(${pump_id}_period4_end_hour);
    set_action:
      - lambda: |-
          id(${pump_id}_period4_end_hour) = (int)x;
          id(${pump_id}_period4_end_hour_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 4 - End Hour = %d", id(${pump_id}_period4_end_hour));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 4 - End Minute"
    id: ${pump_id}_period4_end_minute_num
    icon: mdi:clock-end
    min_value: 0
    max_value: 59
    step: 1
    lambda: |-
      return id(${pump_id}_period4_end_minute);
    set_action:
      - lambda: |-
          id(${pump_id}_period4_end_minute) = (int)x;
          id(${pump_id}_period4_end_minute_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 4 - End Minute = %d", id(${pump_id}_period4_end_minute));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 4 - Doses"
    id: ${pump_id}_period4_doses_num
    icon: mdi:counter
    min_value: 0
    max_value: 20
    step: 1
    lambda: |-
      return id(${pump_id}_period4_doses);
    set_action:
      - lambda: |-
          id(${pump_id}_period4_doses) = (int)x;
          id(${pump_id}_period4_doses_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 4 - Doses = %d", id(${pump_id}_period4_doses));
    web_server:
      sorting_group_id: sorting_group_mode3
# PÃ‰RIODE 5
  - platform: template
    name: "PÃ©riode 5 - Start Hour"
    id: ${pump_id}_period5_start_hour_num
    icon: mdi:clock-start
    min_value: 0
    max_value: 23
    step: 1
    lambda: |-
      return id(${pump_id}_period5_start_hour);
    set_action:
      - lambda: |-
          id(${pump_id}_period5_start_hour) = (int)x;
          id(${pump_id}_period5_start_hour_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 5 - Start Hour = %d", id(${pump_id}_period5_start_hour));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 5 - Start Minute"
    id: ${pump_id}_period5_start_minute_num
    icon: mdi:clock-start
    min_value: 0
    max_value: 59
    step: 1
    lambda: |-
      return id(${pump_id}_period5_start_minute);
    set_action:
      - lambda: |-
          id(${pump_id}_period5_start_minute) = (int)x;
          id(${pump_id}_period5_start_minute_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 5 - Start Minute = %d", id(${pump_id}_period5_start_minute));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 5 - End Hour"
    id: ${pump_id}_period5_end_hour_num
    icon: mdi:clock-end
    min_value: 0
    max_value: 23
    step: 1
    lambda: |-
      return id(${pump_id}_period5_end_hour);
    set_action:
      - lambda: |-
          id(${pump_id}_period5_end_hour) = (int)x;
          id(${pump_id}_period5_end_hour_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 5 - End Hour = %d", id(${pump_id}_period5_end_hour));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 5 - End Minute"
    id: ${pump_id}_period5_end_minute_num
    icon: mdi:clock-end
    min_value: 0
    max_value: 59
    step: 1
    lambda: |-
      return id(${pump_id}_period5_end_minute);
    set_action:
      - lambda: |-
          id(${pump_id}_period5_end_minute) = (int)x;
          id(${pump_id}_period5_end_minute_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 5 - End Minute = %d", id(${pump_id}_period5_end_minute));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 5 - Doses"
    id: ${pump_id}_period5_doses_num
    icon: mdi:counter
    min_value: 0
    max_value: 20
    step: 1
    lambda: |-
      return id(${pump_id}_period5_doses);
    set_action:
      - lambda: |-
          id(${pump_id}_period5_doses) = (int)x;
          id(${pump_id}_period5_doses_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 5 - Doses = %d", id(${pump_id}_period5_doses));
    web_server:
      sorting_group_id: sorting_group_mode3
# PÃ‰RIODE 6
  - platform: template
    name: "PÃ©riode 6 - Start Hour"
    id: ${pump_id}_period6_start_hour_num
    icon: mdi:clock-start
    min_value: 0
    max_value: 23
    step: 1
    lambda: |-
      return id(${pump_id}_period6_start_hour);
    set_action:
      - lambda: |-
          id(${pump_id}_period6_start_hour) = (int)x;
          id(${pump_id}_period6_start_hour_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 6 - Start Hour = %d", id(${pump_id}_period6_start_hour));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 6 - Start Minute"
    id: ${pump_id}_period6_start_minute_num
    icon: mdi:clock-start
    min_value: 0
    max_value: 59
    step: 1
    lambda: |-
      return id(${pump_id}_period6_start_minute);
    set_action:
      - lambda: |-
          id(${pump_id}_period6_start_minute) = (int)x;
          id(${pump_id}_period6_start_minute_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 6 - Start Minute = %d", id(${pump_id}_period6_start_minute));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 6 - End Hour"
    id: ${pump_id}_period6_end_hour_num
    icon: mdi:clock-end
    min_value: 0
    max_value: 23
    step: 1
    lambda: |-
      return id(${pump_id}_period6_end_hour);
    set_action:
      - lambda: |-
          id(${pump_id}_period6_end_hour) = (int)x;
          id(${pump_id}_period6_end_hour_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 6 - End Hour = %d", id(${pump_id}_period6_end_hour));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 6 - End Minute"
    id: ${pump_id}_period6_end_minute_num
    icon: mdi:clock-end
    min_value: 0
    max_value: 59
    step: 1
    lambda: |-
      return id(${pump_id}_period6_end_minute);
    set_action:
      - lambda: |-
          id(${pump_id}_period6_end_minute) = (int)x;
          id(${pump_id}_period6_end_minute_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 6 - End Minute = %d", id(${pump_id}_period6_end_minute));
    web_server:
      sorting_group_id: sorting_group_mode3
  - platform: template
    name: "PÃ©riode 6 - Doses"
    id: ${pump_id}_period6_doses_num
    icon: mdi:counter
    min_value: 0
    max_value: 20
    step: 1
    lambda: |-
      return id(${pump_id}_period6_doses);
    set_action:
      - lambda: |-
          id(${pump_id}_period6_doses) = (int)x;
          id(${pump_id}_period6_doses_num).publish_state(x);
          ESP_LOGD("pump", "PÃ©riode 6 - Doses = %d", id(${pump_id}_period6_doses));
    web_server:
      sorting_group_id: sorting_group_mode3
  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘   MODE 4 - Minuteur (doses Ã  lâ€™heure) â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # -------------------------------------
  #  MINUTEUR (DOSES 1 Ã€ 12)
  # -------------------------------------
# Minuteur 1
  - platform: template
    name: "Minuteur Dose 1 - Hour"
    id: ${pump_id}_minute_dose_1_hour_num
    icon: mdi:clock-outline
    min_value: 0
    max_value: 23
    step: 1
    lambda: |-
      return id(${pump_id}_minute_dose_1_hour);
    set_action:
      - lambda: |-
          id(${pump_id}_minute_dose_1_hour) = (int)x;
          id(${pump_id}_minute_dose_1_hour_num).publish_state(x);
          ESP_LOGD("pump", "Minuteur Dose 1 Hour = %d", id(${pump_id}_minute_dose_1_hour));
    web_server:
      sorting_group_id: sorting_group_mode4

  - platform: template
    name: "Minuteur Dose 1 - Minute"
    id: ${pump_id}_minute_dose_1_minute_num
    icon: mdi:clock-outline
    min_value: 0
    max_value: 59
    step: 1
    lambda: |-
      return id(${pump_id}_minute_dose_1_minute);
    set_action:
      - lambda: |-
          id(${pump_id}_minute_dose_1_minute) = (int)x;
          id(${pump_id}_minute_dose_1_minute_num).publish_state(x);
          ESP_LOGD("pump", "Minuteur Dose 1 Minute = %d", id(${pump_id}_minute_dose_1_minute));
    web_server:
      sorting_group_id: sorting_group_mode4
      
  - platform: template
    name: "Minuteur Dose 1 - Quantity (ml)"
    id: ${pump_id}_minute_dose_1_quantity_num
    icon: mdi:beaker
    min_value: 0
    max_value: 1000
    step: 1
    lambda: |-
      return id(${pump_id}_minute_dose_1_quantity);
    set_action:
      - lambda: |-
          id(${pump_id}_minute_dose_1_quantity) = x;
          id(${pump_id}_minute_dose_1_quantity_num).publish_state(x);
          ESP_LOGD("pump", "Minuteur Dose 1 Quantity = %.1f ml", id(${pump_id}_minute_dose_1_quantity));
      - script.execute: update_computed_daily_quantity
      - script.execute: refresh_daily_quantity_sensor

    web_server:
      sorting_group_id: sorting_group_mode4
      
# Minuteur 2
  - platform: template
    name: "Minuteur Dose 2 - Hour"
    id: ${pump_id}_minute_dose_2_hour_num
    icon: mdi:clock-outline
    min_value: 0
    max_value: 23
    step: 1
    lambda: |-
      return id(${pump_id}_minute_dose_2_hour);
    set_action:
      - lambda: |-
          id(${pump_id}_minute_dose_2_hour) = (int)x;
          id(${pump_id}_minute_dose_2_hour_num).publish_state(x);
          ESP_LOGD("pump", "Minuteur Dose 2 Hour = %d", id(${pump_id}_minute_dose_2_hour));
    web_server:
      sorting_group_id: sorting_group_mode4
      
  - platform: template
    name: "Minuteur Dose 2 - Minute"
    id: ${pump_id}_minute_dose_2_minute_num
    icon: mdi:clock-outline
    min_value: 0
    max_value: 59
    step: 1
    lambda: |-
      return id(${pump_id}_minute_dose_2_minute);
    set_action:
      - lambda: |-
          id(${pump_id}_minute_dose_2_minute) = (int)x;
          id(${pump_id}_minute_dose_2_minute_num).publish_state(x);
          ESP_LOGD("pump", "Minuteur Dose 2 Minute = %d", id(${pump_id}_minute_dose_2_minute));
    web_server:
      sorting_group_id: sorting_group_mode4
      
  - platform: template
    name: "Minuteur Dose 2 - Quantity (ml)"
    id: ${pump_id}_minute_dose_2_quantity_num
    icon: mdi:beaker
    min_value: 0
    max_value: 1000
    step: 1
    lambda: |-
      return id(${pump_id}_minute_dose_2_quantity);
    set_action:
      - lambda: |-
          id(${pump_id}_minute_dose_2_quantity) = x;
          id(${pump_id}_minute_dose_2_quantity_num).publish_state(x);
          ESP_LOGD("pump", "Minuteur Dose 2 Quantity = %.1f ml", id(${pump_id}_minute_dose_2_quantity));
      - script.execute: update_computed_daily_quantity
      - script.execute: refresh_daily_quantity_sensor

    web_server:
      sorting_group_id: sorting_group_mode4
# Minuteur 3
  - platform: template
    name: "Minuteur Dose 3 - Hour"
    id: ${pump_id}_minute_dose_3_hour_num
    icon: mdi:clock-outline
    min_value: 0
    max_value: 23
    step: 1
    lambda: |-
      return id(${pump_id}_minute_dose_3_hour);
    set_action:
      - lambda: |-
          id(${pump_id}_minute_dose_3_hour) = (int)x;
          id(${pump_id}_minute_dose_3_hour_num).publish_state(x);
          ESP_LOGD("pump", "Minuteur Dose 3 Hour = %d", id(${pump_id}_minute_dose_3_hour));
    web_server:
      sorting_group_id: sorting_group_mode4
      
  - platform: template
    name: "Minuteur Dose 3 - Minute"
    id: ${pump_id}_minute_dose_3_minute_num
    icon: mdi:clock-outline
    min_value: 0
    max_value: 59
    step: 1
    lambda: |-
      return id(${pump_id}_minute_dose_3_minute);
    set_action:
      - lambda: |-
          id(${pump_id}_minute_dose_3_minute) = (int)x;
          id(${pump_id}_minute_dose_3_minute_num).publish_state(x);
          ESP_LOGD("pump", "Minuteur Dose 3 Minute = %d", id(${pump_id}_minute_dose_3_minute));
    web_server:
      sorting_group_id: sorting_group_mode4
      
  - platform: template
    name: "Minuteur Dose 3 - Quantity (ml)"
    id: ${pump_id}_minute_dose_3_quantity_num
    icon: mdi:beaker
    min_value: 0
    max_value: 1000
    step: 1
    lambda: |-
      return id(${pump_id}_minute_dose_3_quantity);
    set_action:
      - lambda: |-
          id(${pump_id}_minute_dose_3_quantity) = x;
          id(${pump_id}_minute_dose_3_quantity_num).publish_state(x);
          ESP_LOGD("pump", "Minuteur Dose 3 Quantity = %.1f ml", id(${pump_id}_minute_dose_3_quantity));
      - script.execute: update_computed_daily_quantity
      - script.execute: refresh_daily_quantity_sensor
    web_server:
      sorting_group_id: sorting_group_mode4
# Minuteur 4
  - platform: template
    name: "Minuteur Dose 4 - Hour"
    id: ${pump_id}_minute_dose_4_hour_num
    icon: mdi:clock-outline
    min_value: 0
    max_value: 23
    step: 1
    lambda: |-
      return id(${pump_id}_minute_dose_4_hour);
    set_action:
      - lambda: |-
          id(${pump_id}_minute_dose_4_hour) = (int)x;
          id(${pump_id}_minute_dose_4_hour_num).publish_state(x);
          ESP_LOGD("pump", "Minuteur Dose 4 Hour = %d", id(${pump_id}_minute_dose_4_hour));
    web_server:
      sorting_group_id: sorting_group_mode4
      
  - platform: template
    name: "Minuteur Dose 4 - Minute"
    id: ${pump_id}_minute_dose_4_minute_num
    icon: mdi:clock-outline
    min_value: 0
    max_value: 59
    step: 1
    lambda: |-
      return id(${pump_id}_minute_dose_4_minute);
    set_action:
      - lambda: |-
          id(${pump_id}_minute_dose_4_minute) = (int)x;
          id(${pump_id}_minute_dose_4_minute_num).publish_state(x);
          ESP_LOGD("pump", "Minuteur Dose 4 Minute = %d", id(${pump_id}_minute_dose_4_minute));
    web_server:
      sorting_group_id: sorting_group_mode4
      
  - platform: template
    name: "Minuteur Dose 4 - Quantity (ml)"
    id: ${pump_id}_minute_dose_4_quantity_num
    icon: mdi:beaker
    min_value: 0
    max_value: 1000
    step: 1
    lambda: |-
      return id(${pump_id}_minute_dose_4_quantity);
    set_action:
      - lambda: |-
          id(${pump_id}_minute_dose_4_quantity) = x;
          id(${pump_id}_minute_dose_4_quantity_num).publish_state(x);
          ESP_LOGD("pump", "Minuteur Dose 4 Quantity = %.1f ml", id(${pump_id}_minute_dose_4_quantity));
      - script.execute: update_computed_daily_quantity
      - script.execute: refresh_daily_quantity_sensor
    web_server:
      sorting_group_id: sorting_group_mode4
# Minuteur 5
  - platform: template
    name: "Minuteur Dose 5 - Hour"
    id: ${pump_id}_minute_dose_5_hour_num
    icon: mdi:clock-outline
    min_value: 0
    max_value: 23
    step: 1
    lambda: |-
      return id(${pump_id}_minute_dose_5_hour);
    set_action:
      - lambda: |-
          id(${pump_id}_minute_dose_5_hour) = (int)x;
          id(${pump_id}_minute_dose_5_hour_num).publish_state(x);
          ESP_LOGD("pump", "Minuteur Dose 5 Hour = %d", id(${pump_id}_minute_dose_5_hour));
    web_server:
      sorting_group_id: sorting_group_mode4
      
  - platform: template
    name: "Minuteur Dose 5 - Minute"
    id: ${pump_id}_minute_dose_5_minute_num
    icon: mdi:clock-outline
    min_value: 0
    max_value: 59
    step: 1
    lambda: |-
      return id(${pump_id}_minute_dose_5_minute);
    set_action:
      - lambda: |-
          id(${pump_id}_minute_dose_5_minute) = (int)x;
          id(${pump_id}_minute_dose_5_minute_num).publish_state(x);
          ESP_LOGD("pump", "Minuteur Dose 5 Minute = %d", id(${pump_id}_minute_dose_5_minute));
    web_server:
      sorting_group_id: sorting_group_mode4
      
  - platform: template
    name: "Minuteur Dose 5 - Quantity (ml)"
    id: ${pump_id}_minute_dose_5_quantity_num
    icon: mdi:beaker
    min_value: 0
    max_value: 1000
    step: 1
    lambda: |-
      return id(${pump_id}_minute_dose_5_quantity);
    set_action:
      - lambda: |-
          id(${pump_id}_minute_dose_5_quantity) = x;
          id(${pump_id}_minute_dose_5_quantity_num).publish_state(x);
          ESP_LOGD("pump", "Minuteur Dose 5 Quantity = %.1f ml", id(${pump_id}_minute_dose_5_quantity));
      - script.execute: update_computed_daily_quantity
      - script.execute: refresh_daily_quantity_sensor
    web_server:
      sorting_group_id: sorting_group_mode4
# Minuteur 6
  - platform: template
    name: "Minuteur Dose 6 - Hour"
    id: ${pump_id}_minute_dose_6_hour_num
    icon: mdi:clock-outline
    min_value: 0
    max_value: 23
    step: 1
    lambda: |-
      return id(${pump_id}_minute_dose_6_hour);
    set_action:
      - lambda: |-
          id(${pump_id}_minute_dose_6_hour) = (int)x;
          id(${pump_id}_minute_dose_6_hour_num).publish_state(x);
          ESP_LOGD("pump", "Minuteur Dose 6 Hour = %d", id(${pump_id}_minute_dose_6_hour));
    web_server:
      sorting_group_id: sorting_group_mode4
      
  - platform: template
    name: "Minuteur Dose 6 - Minute"
    id: ${pump_id}_minute_dose_6_minute_num
    icon: mdi:clock-outline
    min_value: 0
    max_value: 59
    step: 1
    lambda: |-
      return id(${pump_id}_minute_dose_6_minute);
    set_action:
      - lambda: |-
          id(${pump_id}_minute_dose_6_minute) = (int)x;
          id(${pump_id}_minute_dose_6_minute_num).publish_state(x);
          ESP_LOGD("pump", "Minuteur Dose 6 Minute = %d", id(${pump_id}_minute_dose_6_minute));
    web_server:
      sorting_group_id: sorting_group_mode4
      
  - platform: template
    name: "Minuteur Dose 6 - Quantity (ml)"
    id: ${pump_id}_minute_dose_6_quantity_num
    icon: mdi:beaker
    min_value: 0
    max_value: 1000
    step: 1
    lambda: |-
      return id(${pump_id}_minute_dose_6_quantity);
    set_action:
      - lambda: |-
          id(${pump_id}_minute_dose_6_quantity) = x;
          id(${pump_id}_minute_dose_6_quantity_num).publish_state(x);
          ESP_LOGD("pump", "Minuteur Dose 6 Quantity = %.1f ml", id(${pump_id}_minute_dose_6_quantity));
      - script.execute: update_computed_daily_quantity
      - script.execute: refresh_daily_quantity_sensor
    web_server:
      sorting_group_id: sorting_group_mode4
      
select:
  - platform: template
    name: "${pump_name} - Mode de Distribution"
    id: ${pump_id}_distribution_select
    icon: mdi:format-list-bulleted
    entity_category: config
    options:
      - "Mode 0: Dose manuelle"
      - "Mode 1: 24 doses"
      - "Mode 2: 12 doses"
      - "Mode 3: PÃ©riodes"
      - "Mode 4: Minuteur"
    lambda: |-
      int mode = id(${pump_id}_distribution_mode);
      if (mode == 0) return std::string("Mode 0: Dose manuelle");
      else if (mode == 1) return std::string("Mode 1: 24 doses");
      else if (mode == 2) return std::string("Mode 2: 12 doses");
      else if (mode == 3) return std::string("Mode 3: PÃ©riodes");
      else if (mode == 4) return std::string("Mode 4: Minuteur");
      return {};
    set_action:
      - lambda: |-
          if (x == "Mode 0: Dose manuelle") id(${pump_id}_distribution_mode) = 0;
          else if (x == "Mode 1: 24 doses") id(${pump_id}_distribution_mode) = 1;
          else if (x == "Mode 2: 12 doses") id(${pump_id}_distribution_mode) = 2;
          else if (x == "Mode 3: PÃ©riodes") id(${pump_id}_distribution_mode) = 3;
          else if (x == "Mode 4: Minuteur") id(${pump_id}_distribution_mode) = 4;
          id(${pump_id}_distribution_select).publish_state(x);
          ESP_LOGD("pump", "Nouveau mode = %d", id(${pump_id}_distribution_mode));
      - script.execute: update_computed_daily_quantity
      - script.execute: refresh_daily_quantity_sensor
  - platform: template
    name: "${pump_name} - Vitesse"
    id: ${pump_id}_speed_select
    icon: mdi:speedometer
    entity_category: config
    options:
      - "Lent"
      - "Moyen"
      - "Rapide"
    lambda: |-
      int lvl = id(${pump_id}_speed_level);
      if (lvl == 0) return std::string("Lent");
      else if (lvl == 1) return std::string("Moyen");
      else return std::string("Rapide");
    set_action:
      - lambda: |-
          if (x == "Lent") id(${pump_id}_speed_level) = 0;
          else if (x == "Moyen") id(${pump_id}_speed_level) = 1;
          else if (x == "Rapide") id(${pump_id}_speed_level) = 2;
          id(${pump_id}_speed_select).publish_state(x);
          ESP_LOGD("pump", "Niveau de vitesse mis Ã  %d", id(${pump_id}_speed_level));
      - script.execute: apply_${pump_id}_speed_profile
    web_server:
      sorting_group_id: sorting_group_general
#####################################
#          SCRIPTS DE DOSAGE        #
#####################################
# Ce script exÃ©cute le moteur pour dÃ©livrer un volume dose_ml calculÃ©
script:
  - id: apply_${pump_id}_speed_profile
    mode: restart
    then:
      - lambda: |-
          int lvl = id(${pump_id}_speed_level);

          int speed = 600;
          int chunk = 32;

          if (lvl == 0) {
            // Lent â€“ rÃ©fÃ©rence sÃ»re
            speed = 600;
            chunk = 32;

          } else if (lvl == 1) {
            // Moyen â€“ rapide et stable
            speed = 800;
            chunk = 64;

          } else if (lvl == 2) {
            // Rapide â€“ limite haute moteur
            speed = 1000;
            chunk = 64;
          }
          id(${pump_id}_stepper).set_max_speed(speed);
          id(${pump_id}_current_speed) = speed;
          id(${pump_id}_chunk_size) = chunk;
          ESP_LOGI(
            "pump_test",
            "PROFILE | lvl=%d speed=%d steps/s chunk=%d",
            lvl, speed, chunk
          );
  - id: finalize_${pump_id}_manual_dose
    mode: restart
    then:
      - lambda: |-
          char buffer[40];
          auto now = id(my_time).now();
          float dose_ml = id(${pump_id}_dose_ml);
          sprintf(buffer, "%04d-%02d-%02d %02d:%02d - %.1f ml", now.year, now.month, now.day_of_month, now.hour, now.minute, dose_ml);
          id(${pump_id}_distributed_today) += dose_ml;
          id(${pump_id}_used_today) += dose_ml;
          id(${pump_id}_volume_remaining) = std::max(0.0f, id(${pump_id}_volume_remaining) - dose_ml);
          id(${pump_id}_volume_remaining_sensor).publish_state(id(${pump_id}_volume_remaining));
          id(${pump_id}_last_dose_log) = buffer;
          id(${pump_id}_last_dose_text).update();
          id(${pump_id}_manual_dose_active) = false;
          id(${pump_id}_status).publish_state("PrÃªt");
          ESP_LOGI(
            "pump_test",
            "END | speed=%d chunk=%d steps=%d ml=%.2f",
            id(${pump_id}_current_speed),
            id(${pump_id}_chunk_size),
            id(${pump_id}_steps_to_run),
            id(${pump_id}_dose_ml)
          );
          ESP_LOGI("pump", "âœ… Distribution manuelle terminÃ©e.");
          id(${pump_id}_motor_power).turn_off();
          ESP_LOGI("pump", "ğŸ”Œ Moteur dÃ©salimentÃ© (fin distribution).");
          id(${pump_id}_stepper).set_sleep_when_done(true);
          id(${pump_id}_stepper).set_target(id(${pump_id}_stepper).current_position);
  - id: run_${pump_id}_steps
    mode: restart
    then:
      - script.execute: apply_${pump_id}_speed_profile
      - switch.turn_on: ${pump_id}_motor_power
      - lambda: |-
          id(${pump_id}_stepper).set_sleep_when_done(false);
          if (id(${pump_id}_volume_remaining) <= 0) {
            ESP_LOGW("pump", "âš ï¸ Volume insuffisant, distribution annulÃ©e.");
            id(${pump_id}_status).publish_state("RÃ©servoir vide");
            id(${pump_id}_volume_remaining_sensor).publish_state(id(${pump_id}_volume_remaining));
            return;
          }
          if (id(${pump_id}_calibration_steps_remaining) > 0) {
            ESP_LOGW("pump", "âš ï¸ Calibration en cours, distribution annulÃ©e.");
            return;
          }
          if (id(${pump_id}_manual_dose_active)) {
            ESP_LOGW("pump", "âš ï¸ Une distribution est dÃ©jÃ  en cours, exÃ©cution ignorÃ©e.");
            return;
          }
          float dose_ml = id(${pump_id}_dose_ml);
          float factor = id(${pump_id}_calibration_factor);
          id(${pump_id}_steps_to_run) = (int)(dose_ml / factor);
          id(${pump_id}_steps_remaining) = id(${pump_id}_steps_to_run);
          id(${pump_id}_manual_dose_active) = true;
          id(${pump_id}_status).publish_state("Distribution en coursâ€¦");
          ESP_LOGI("pump", "âš™ï¸ DÃ©but distribution : %d pas", id(${pump_id}_steps_to_run));
      - script.execute: run_${pump_id}_step_chunk
  - id: run_${pump_id}_step_chunk
    mode: restart
    then:
      - lambda: |-
          if (id(${pump_id}_abort_requested)) {
            ESP_LOGW("pump", "â›” Distribution interrompue par l'utilisateur.");
            id(${pump_id}_abort_requested) = false;
            id(${pump_id}_manual_dose_active) = false;
            id(${pump_id}_status).publish_state("Interrompu");
            return;
          }
          if (id(${pump_id}_steps_remaining) <= 0) {
            id(finalize_${pump_id}_manual_dose).execute();
            return;
          }
          int chunk = id(${pump_id}_steps_remaining) > id(${pump_id}_chunk_size)
              ? id(${pump_id}_chunk_size)
              : id(${pump_id}_steps_remaining);
          id(${pump_id}_current_chunk) = chunk;
          id(${pump_id}_steps_remaining) -= chunk;
          id(${pump_id}_chunk_target) =
              id(${pump_id}_stepper).current_position + chunk;
      - stepper.set_target:
          id: ${pump_id}_stepper
          target: !lambda 'return id(${pump_id}_chunk_target);'
      - delay: !lambda |-
          return (id(${pump_id}_current_chunk) * 1000.0f)
                 / id(${pump_id}_current_speed);
      - if:
          condition:
            lambda: 'return id(${pump_id}_manual_dose_active) && id(${pump_id}_steps_remaining) > 0;'
          then:
            - script.execute: run_${pump_id}_step_chunk
          else:
            - script.execute: finalize_${pump_id}_manual_dose
  - id: refresh_daily_quantity_sensor
    mode: queued
    then:
      - component.update: ${pump_id}_daily_quantity_sensor
  - id: update_computed_daily_quantity
    mode: queued
    then:
      - lambda: |-
          float total = id(${pump_id}_minute_dose_1_quantity) +
                        id(${pump_id}_minute_dose_2_quantity) +
                        id(${pump_id}_minute_dose_3_quantity) +
                        id(${pump_id}_minute_dose_4_quantity) +
                        id(${pump_id}_minute_dose_5_quantity) +
                        id(${pump_id}_minute_dose_6_quantity) +
                        id(${pump_id}_minute_dose_7_quantity) +
                        id(${pump_id}_minute_dose_8_quantity) +
                        id(${pump_id}_minute_dose_9_quantity) +
                        id(${pump_id}_minute_dose_10_quantity) +
                        id(${pump_id}_minute_dose_11_quantity) +
                        id(${pump_id}_minute_dose_12_quantity);
          id(${pump_id}_daily_quantity_computed) = total;
          ESP_LOGD("pump", "Recalcul immÃ©diat du volume total : %.1f ml", total);
  - id: priming_${pump_id}_steps
    mode: restart
    then:
      - script.execute: apply_${pump_id}_speed_profile
      - lambda: |-
          id(${pump_id}_current_speed) = std::max(id(${pump_id}_current_speed), 700);
          id(${pump_id}_stepper).set_max_speed(id(${pump_id}_current_speed));
      - stepper.set_target:
          id: ${pump_id}_stepper
          target: !lambda 'return id(${pump_id}_stepper).current_position + id(${pump_id}_priming_steps_remaining);'
      - delay: !lambda 'return (id(${pump_id}_priming_steps_remaining) * 1.0f) / id(${pump_id}_current_speed);'
      - lambda: |-
          id(${pump_id}_status).publish_state("PrÃªt");
          ESP_LOGI("pump", "âœ… AmorÃ§age terminÃ©.");
          float priming_ml = id(${pump_id}_priming_steps_remaining) * id(${pump_id}_calibration_factor);
          if (priming_ml > 0) {
            id(${pump_id}_used_today) += priming_ml;
            id(${pump_id}_volume_remaining) =
                std::max(0.0f, id(${pump_id}_volume_remaining) - priming_ml);
            id(${pump_id}_volume_remaining_sensor).publish_state(id(${pump_id}_volume_remaining));
            id(${pump_id}_used_today_sensor).publish_state(id(${pump_id}_used_today));
            ESP_LOGI("pump", "ğŸ“‰ AmorÃ§age: -%.2f ml du rÃ©servoir (hors distribution).", priming_ml);
          }
          id(${pump_id}_priming_steps_remaining) = 0;
      - delay: 10ms
      - switch.turn_off: ${pump_id}_priming_switch
  - id: calibration_${pump_id}_steps
    mode: restart
    then:
      - script.execute: apply_${pump_id}_speed_profile
      - switch.turn_on: ${pump_id}_motor_power
      - lambda: |-
          id(${pump_id}_stepper).set_sleep_when_done(false);
          id(${pump_id}_abort_requested) = false;
          id(${pump_id}_calibration_steps_done) = 0;
          id(${pump_id}_calibration_volume_estimate) = 0.0f;
          id(${pump_id}_calibration_volume_adjusted) = false;
          ESP_LOGI("pump", "â–¶ï¸ Calibration dÃ©marrÃ©e : %d pas", id(${pump_id}_calibration_steps_remaining));
          id(${pump_id}_current_speed) = std::max(id(${pump_id}_current_speed), 700);
          id(${pump_id}_stepper).set_max_speed(id(${pump_id}_current_speed));
          id(${pump_id}_status).publish_state("Calibration en coursâ€¦");
      - script.execute: run_${pump_id}_calibration_chunk
  - id: finalize_${pump_id}_calibration
    mode: restart
    then:
      - lambda: |-
          if (id(${pump_id}_calibration_steps_done) > 0) {
            float calibration_ml =
                id(${pump_id}_calibration_steps_done) * id(${pump_id}_calibration_factor);
            id(${pump_id}_calibration_volume_estimate) = calibration_ml;
            id(${pump_id}_used_today) += calibration_ml;
            id(${pump_id}_volume_remaining) = std::max(
                0.0f, id(${pump_id}_volume_remaining) - calibration_ml);
            id(${pump_id}_volume_remaining_sensor).publish_state(id(${pump_id}_volume_remaining));
            id(${pump_id}_used_today_sensor).publish_state(id(${pump_id}_used_today));
            ESP_LOGI("pump", "ğŸ“‰ Calibration: -%.2f ml du rÃ©servoir (hors distribution).", calibration_ml);
            id(${pump_id}_calibration_steps_done) = 0;
          }
          id(${pump_id}_status).publish_state("Calibr. distribuÃ©e");
          ESP_LOGI("pump", "âœ… Fin de calibration.");
          ESP_LOGI("pump", "âœ… Calibration terminÃ©e, mesurer le volume et valider.");
          id(${pump_id}_stepper).set_sleep_when_done(true);
          id(${pump_id}_stepper).set_target(id(${pump_id}_stepper).current_position);
          id(${pump_id}_motor_power).turn_off();
          ESP_LOGI("pump", "ğŸ”Œ Moteur dÃ©salimentÃ© (fin calibration).");
  - id: run_${pump_id}_calibration_chunk
    mode: restart
    then:
      - lambda: |-
          if (id(${pump_id}_abort_requested)) {
            ESP_LOGW("pump", "â›” Calibration interrompue.");
            id(${pump_id}_abort_requested) = false;
            id(${pump_id}_calibration_steps_remaining) = 0;
            id(${pump_id}_status).publish_state("Interrompu");
            if (id(${pump_id}_calibration_steps_done) > 0) {
              float calibration_ml =
                  id(${pump_id}_calibration_steps_done) * id(${pump_id}_calibration_factor);
              id(${pump_id}_calibration_volume_estimate) = calibration_ml;
              id(${pump_id}_used_today) += calibration_ml;
              id(${pump_id}_volume_remaining) = std::max(
                  0.0f, id(${pump_id}_volume_remaining) - calibration_ml);
              id(${pump_id}_volume_remaining_sensor).publish_state(id(${pump_id}_volume_remaining));
              id(${pump_id}_used_today_sensor).publish_state(id(${pump_id}_used_today));
              ESP_LOGI("pump", "ğŸ“‰ Calibration interrompue: -%.2f ml du rÃ©servoir.", calibration_ml);
              id(${pump_id}_calibration_steps_done) = 0;
            }
            id(${pump_id}_stepper).set_sleep_when_done(true);
            id(${pump_id}_stepper).set_target(id(${pump_id}_stepper).current_position);
            id(${pump_id}_motor_power).turn_off();
            ESP_LOGI("pump", "ğŸ”Œ Moteur dÃ©salimentÃ© (calibration interrompue).");
            return;
          }
          if (id(${pump_id}_calibration_steps_remaining) <= 0) {
            id(finalize_${pump_id}_calibration).execute();
            return;
          }
          int chunk = id(${pump_id}_calibration_steps_remaining) > id(${pump_id}_chunk_size)
              ? id(${pump_id}_chunk_size)
              : id(${pump_id}_calibration_steps_remaining);
          id(${pump_id}_current_chunk) = chunk;
          id(${pump_id}_calibration_steps_remaining) -= chunk;
          id(${pump_id}_calibration_steps_done) += chunk;
          id(${pump_id}_calibration_target) = id(${pump_id}_stepper).current_position + id(${pump_id}_current_chunk);
      - stepper.set_target:
          id: ${pump_id}_stepper
          target: !lambda 'return id(${pump_id}_calibration_target);'
      - delay: !lambda |-
          return (id(${pump_id}_current_chunk) * 1000.0f)
                 / id(${pump_id}_current_speed);
      - if:
          condition:
            lambda: 'return id(${pump_id}_calibration_steps_remaining) > 0 && !id(${pump_id}_abort_requested);'
          then:
            - script.execute: run_${pump_id}_calibration_chunk
          else:
            - script.execute: finalize_${pump_id}_calibration
  #-------------------------------------
  # SCRIPT D'AMORÃ‡AGE : vitesse rapide
  #-------------------------------------
  - id: priming_${pump_id}_steps_fast
    mode: restart
    then:
      - lambda: |-
          id(${pump_id}_stepper_speed_saved) = id(${pump_id}_current_speed);
          id(${pump_id}_fast_target) = id(${pump_id}_stepper).current_position + id(${pump_id}_priming_steps_remaining);
          id(${pump_id}_stepper).set_max_speed(1500);
      - stepper.set_target:
          id: ${pump_id}_stepper
          target: !lambda 'return id(${pump_id}_fast_target);'
      - wait_until:
          condition:
            lambda: 'return id(${pump_id}_stepper).current_position >= id(${pump_id}_fast_target);'
      - lambda: |-
          id(${pump_id}_stepper).set_max_speed(id(${pump_id}_stepper_speed_saved));
          id(${pump_id}_current_speed) = id(${pump_id}_stepper_speed_saved);
          id(${pump_id}_status).publish_state("PrÃªt");
          ESP_LOGI("pump", "âœ… AmorÃ§age terminÃ©.");
          float priming_ml = id(${pump_id}_priming_steps_remaining) * id(${pump_id}_calibration_factor);
          if (priming_ml > 0) {
            id(${pump_id}_used_today) += priming_ml;
            id(${pump_id}_volume_remaining) =
                std::max(0.0f, id(${pump_id}_volume_remaining) - priming_ml);
            id(${pump_id}_volume_remaining_sensor).publish_state(id(${pump_id}_volume_remaining));
            id(${pump_id}_used_today_sensor).publish_state(id(${pump_id}_used_today));
            ESP_LOGI("pump", "ğŸ“‰ AmorÃ§age: -%.2f ml du rÃ©servoir (hors distribution).", priming_ml);
          }
          id(${pump_id}_priming_steps_remaining) = 0;
      - delay: 10ms
      - switch.turn_off: ${pump_id}_priming_switch
      - lambda: |-
            if (!id(${pump_id}_enabled)) return;

            // RÃ©cupÃ©ration de lâ€™heure actuelle
            auto now = id(my_time).now();
            if (id(${pump_id}_test_mode)) {
              now.minute = (int)((id(uptime_sensor).state / 2)) % 60;
              now.hour = (int)((id(uptime_sensor).state / 120)) % 24;
            }
            int current_hour = now.hour;
            int current_minute = now.minute;
            // Mode de distribution
            int mode = id(${pump_id}_distribution_mode);

            // ğŸ”¹ Log de debug : mode + heure
            ESP_LOGD("pump", "Mode actif : %d - Heure actuelle : %02d:%02d", mode, current_hour, current_minute);

            // --- Mode 0 : Dose manuelle ---
            // (aucune distribution automatique : seul le bouton de dose manuelle dÃ©clenche)
            // --- Mode 1 : 24 doses par jour (chaque heure) ---
            if (mode == 1) {
              if (current_minute == id(${pump_id}_dose_offset_minute)) {
                static int last_dose_hour = -1;
                if (current_hour != last_dose_hour) {
                  last_dose_hour = current_hour;
                  id(${pump_id}_dose_ml) = id(${pump_id}_daily_quantity) / 24.0;
                  ESP_LOGD("pump", "Dose horaire (24 doses) dÃ©clenchÃ©e pour %dh: %.2f ml", current_hour, id(${pump_id}_dose_ml));
                  id(${pump_id}_distributed_today) += id(${pump_id}_dose_ml);
                  if (id(${pump_id}_test_mode)) {
                    ESP_LOGI("pump", "ğŸ§ª [Test] Simulation dose Mode 1 Ã  %dh : %.2f ml", current_hour, id(${pump_id}_dose_ml));
                    id(${pump_id}_distributed_today) += id(${pump_id}_dose_ml);
                  } else {
                    id(run_${pump_id}_steps).execute();
                  }
                }
              }
            }
            // --- Mode 2 : 12 doses par jour (toutes les 2 heures) ---
            else if (mode == 2) {
              if (current_minute == id(${pump_id}_dose_offset_minute) && (current_hour % 2 == 0)) {
                static int last_dose_hour = -1;
                if (current_hour != last_dose_hour) {
                  last_dose_hour = current_hour;
                  id(${pump_id}_dose_ml) = id(${pump_id}_daily_quantity) / 12.0;
                  ESP_LOGD("pump", "Dose toutes les 2h (12 doses) dÃ©clenchÃ©e pour %dh: %.2f ml", current_hour, id(${pump_id}_dose_ml));
                  id(${pump_id}_distributed_today) += id(${pump_id}_dose_ml);
                  if (id(${pump_id}_test_mode)) {
                    ESP_LOGI("pump", "ğŸ§ª [Test] Simulation dose Mode 2 Ã  %dh : %.2f ml", current_hour, id(${pump_id}_dose_ml));
                    id(${pump_id}_distributed_today) += id(${pump_id}_dose_ml);
                  } else {
                    id(run_${pump_id}_steps).execute();
                  }
                }
              }
            }
#####################################
#            SWITCHES               #
#####################################
switch:
  - platform: gpio
    id: ${pump_id}_motor_power
    pin: GPIO25 # Ã  adapter (MOSFET/transistor/relais)
    restore_mode: ALWAYS_OFF
  # Activation globale
  - platform: template
    name: "Activation ${pump_name}"
    id: ${pump_id}_enable_switch
    restore_mode: RESTORE_DEFAULT_ON
    optimistic: true
    entity_category: config
    lambda: |-
      return id(${pump_id}_enabled);
    turn_on_action:
      - lambda: |-
          id(${pump_id}_enabled) = true;
          id(${pump_id}_enable_switch).publish_state(true);
          ESP_LOGD("pump", "Pompe activÃ©e !");
    turn_off_action:
      - lambda: |-
          id(${pump_id}_enabled) = false;
          id(${pump_id}_enable_switch).publish_state(false);
          ESP_LOGD("pump", "Pompe dÃ©sactivÃ©e !");
    web_server:
      sorting_group_id: sorting_group_general  # ou diagnostic, misc, etc.
  # AmorÃ§age (remplissage tuyaux)
  - platform: template
    name: "Amorcer ${pump_name} (Priming)"
    id: ${pump_id}_priming_switch
    entity_category: diagnostic
    lambda: return false;
    turn_on_action:
      - lambda: |-
          ESP_LOGD("pump", "AmorÃ§age (Priming) de la pompe 1 : remplissage des tuyaux");
          id(${pump_id}_status).publish_state("AmorÃ§age en coursâ€¦");
          // AmorÃ§age: viser 2 ml en fonction du facteur de calibration
          float factor = id(${pump_id}_calibration_factor);
          bool has_calibration = id(${pump_id}_last_calibration) > 0 && factor > 0.0f;
          if (!has_calibration) {
            ESP_LOGW("pump", "âš ï¸ AmorÃ§age: calibration absente ou rÃ©initialisÃ©e, utilisation du mode par dÃ©faut (2500 pas).");
          }
          int priming_steps = has_calibration ? (int) ceilf(2.0f / factor) : 2500;
          id(${pump_id}_priming_steps_remaining) = priming_steps;
      - script.execute: priming_${pump_id}_steps_fast
      - script.wait: priming_${pump_id}_steps_fast
      - switch.turn_off: ${pump_id}_priming_switch
    web_server:
      sorting_group_id: sorting_group_calibration
  # Mode de test
  - platform: template
    name: "ğŸ§ª Mode Test / Simulation"
    id: ${pump_id}_test_mode_switch
    entity_category: config
    lambda: |-
      return id(${pump_id}_test_mode);
    turn_on_action:
      - lambda: |-
          id(${pump_id}_test_mode) = true;
          id(${pump_id}_test_mode_switch).publish_state(true);
          ESP_LOGW("pump", "Mode test activÃ© : vitesse accÃ©lÃ©rÃ©e");
    turn_off_action:
      - lambda: |-
          id(${pump_id}_test_mode) = false;
          id(${pump_id}_test_mode_switch).publish_state(false);
          ESP_LOGI("pump", "Mode test dÃ©sactivÃ©");
    web_server:
      sorting_group_id: sorting_group_general

button:
  # Bouton pour lancer la calibration
  - platform: template
    name: "Lancer Calibration ${pump_name}"
    id: ${pump_id}_start_calibration_button
    entity_category: diagnostic
    on_press:
      then:
        - lambda: |-
            if (id(${pump_id}_manual_dose_active)) {
              ESP_LOGW("pump", "âš ï¸ Calibration ignorÃ©e : une distribution est en cours.");
              return;
            }
            ESP_LOGI("pump", "Lancement de la calibration (mode asynchrone)...");
            id(${pump_id}_status).publish_state("Calibration en coursâ€¦");
            // Lance la calibration sur le nombre de pas configurÃ©
            id(${pump_id}_calibration_steps_remaining) = id(${pump_id}_calibration_steps) * 2;
        - script.execute: calibration_${pump_id}_steps
    web_server:
      sorting_group_id: sorting_group_calibration  # ou diagnostic, misc, etc.
  # Bouton pour valider la calibration
  - platform: template
    name: "Valider Calibration ${pump_name}"
    id: ${pump_id}_validate_calibration_button
    entity_category: diagnostic
    on_press:
      then:
        - lambda: |-
            int steps = id(${pump_id}_calibration_steps) * 2;
            if (steps <= 0) {
              ESP_LOGW("pump", "âš ï¸ Calibration invalide : nombre de pas <= 0.");
              return;
            }
            float value = id(${pump_id}_calibration_value);
            float factor = value / steps;
            id(${pump_id}_calibration_factor) = factor;
            if (!id(${pump_id}_calibration_volume_adjusted)) {
              float delta = value - id(${pump_id}_calibration_volume_estimate);
              if (fabsf(delta) > 0.0001f) {
                float new_remaining = id(${pump_id}_volume_remaining) - delta;
                float capacity = id(${pump_id}_reservoir_capacity);
                id(${pump_id}_volume_remaining) = std::min(capacity, std::max(0.0f, new_remaining));
                id(${pump_id}_volume_remaining_sensor).publish_state(id(${pump_id}_volume_remaining));
                id(${pump_id}_used_today) = std::max(0.0f, id(${pump_id}_used_today) + delta);
                id(${pump_id}_used_today_sensor).publish_state(id(${pump_id}_used_today));
                ESP_LOGI("pump", "ğŸ“‰ Ajustement calibration: delta=%.2f ml (volume restant ajustÃ©).", delta);
              }
              id(${pump_id}_calibration_volume_adjusted) = true;
              id(${pump_id}_calibration_volume_estimate) = value;
            }
            id(${pump_id}_last_calibration) = id(my_time).now().timestamp;
            id(${pump_id}_status).publish_state("PrÃªt");
            ESP_LOGW("pump", "Calibration validÃ©e: volume=%.2f ml, pas=%d, facteur=%.6f ml/step", value, steps, factor);
    web_server:
      sorting_group_id: sorting_group_calibration  # ou diagnostic, misc, etc.
  - platform: template
    name: "Doser manuellement ${pump_name}"
    id: ${pump_id}_manual_dose_button
    entity_category: diagnostic
    icon: mdi:play-circle
    on_press:
      then:
        - lambda: |-
            ESP_LOGW("pump", "[DEBUG] Bouton pressÃ© - Ã‰tat de ${pump_id}_manual_dose_active = %s", id(${pump_id}_manual_dose_active) ? "true" : "false");
            if (id(${pump_id}_manual_dose_active)) {
              ESP_LOGW("pump", "âš ï¸ Une dose manuelle est dÃ©jÃ  en cours, action ignorÃ©e.");
              return;
            }
            if (!id(${pump_id}_enabled)) {
              ESP_LOGW("pump", "Pompe dÃ©sactivÃ©e : dose manuelle ignorÃ©e.");
              return;
            }
            // Ici on ne met plus ${pump_id}_manual_dose_active Ã  true, on laisse le script principal le faire
            id(${pump_id}_dose_ml) = id(${pump_id}_daily_quantity);
            ESP_LOGD("pump", "Dose manuelle enclenchÃ©e : %.2f ml", id(${pump_id}_dose_ml));
            id(run_${pump_id}_steps).execute();
    web_server:
      sorting_group_id: sorting_group_mode0
  - platform: template
    name: "Stopper distribution ${pump_name}"
    id: ${pump_id}_stop_button
    entity_category: diagnostic
    icon: mdi:stop-circle
    on_press:
      then:
        - lambda: |-
            id(${pump_id}_abort_requested) = true;
            id(${pump_id}_steps_remaining) = 0;
            id(${pump_id}_calibration_steps_remaining) = 0;
            id(${pump_id}_manual_dose_active) = false;
            id(${pump_id}_status).publish_state("Interrompu");
            ESP_LOGW("pump", "â›” ArrÃªt demandÃ© (distribution ou calibration).");
            id(${pump_id}_stepper).set_sleep_when_done(true);
            id(${pump_id}_stepper).set_target(id(${pump_id}_stepper).current_position);
            id(${pump_id}_motor_power).turn_off();
            ESP_LOGW("pump", "ğŸ”Œ Moteur dÃ©salimentÃ© (STOP).");
    web_server:
      sorting_group_id: sorting_group_mode0
  - platform: template
    name: "Remplir rÃ©servoir ${pump_name}"
    id: ${pump_id}_refill_button
    on_press:
      then:
        - lambda: |-
            id(${pump_id}_volume_remaining) = id(${pump_id}_reservoir_capacity);
            id(${pump_id}_volume_remaining_sensor).publish_state(id(${pump_id}_volume_remaining));
            ESP_LOGI("pump", "RÃ©servoir remis Ã  %.0f ml", id(${pump_id}_reservoir_capacity));

  - platform: template
    name: "RÃ©initialiser Historique ${pump_name}"
    id: ${pump_id}_reset_history_button
    entity_category: diagnostic
    icon: mdi:history
    on_press:
      then:
        - lambda: |-
            id(${pump_id}_used_today) = 0.0;
            id(${pump_id}_distributed_today) = 0.0;
            id(${pump_id}_last_dose_log) = "Jamais";
            id(${pump_id}_used_today_sensor).publish_state(id(${pump_id}_used_today));
            id(${pump_id}_distributed_today_sensor).publish_state(id(${pump_id}_distributed_today));
            id(${pump_id}_last_dose_text).update();
            ESP_LOGI("pump", "Historique pompe 1 rÃ©initialisÃ©.");
    web_server:
      sorting_group_id: sorting_group_calibration

interval:
  - interval: 60s
    then:
      - lambda: |-
          // VÃ©rification uniquement si la pompe est activÃ©e
          if (!id(${pump_id}_enabled)) return;

          // RÃ©cupÃ©ration de lâ€™heure actuelle
          auto now = id(my_time).now();
          if (id(${pump_id}_test_mode)) {
            now.minute = (int)((id(uptime_sensor).state / 2)) % 60;
            now.hour = (int)((id(uptime_sensor).state / 120)) % 24;
          }
          int current_hour = now.hour;
          int current_minute = now.minute;
          // Mode de distribution
          int mode = id(${pump_id}_distribution_mode);

          // ğŸ”¹ Log de debug : mode + heure
          ESP_LOGD("pump", "Mode actif : %d - Heure actuelle : %02d:%02d", mode, current_hour, current_minute);

          // --- Mode 0 : Dose manuelle ---
          // (aucune distribution automatique : seul le bouton de dose manuelle dÃ©clenche)
          // --- Mode 1 : 24 doses par jour (chaque heure) ---
          if (mode == 1) {
            if (current_minute == id(${pump_id}_dose_offset_minute)) {
              static int last_dose_hour = -1;
              if (current_hour != last_dose_hour) {
                last_dose_hour = current_hour;
                id(${pump_id}_dose_ml) = id(${pump_id}_daily_quantity) / 24.0;
                ESP_LOGD("pump", "Dose horaire (24 doses) dÃ©clenchÃ©e pour %dh: %.2f ml", current_hour, id(${pump_id}_dose_ml));
                id(${pump_id}_distributed_today) += id(${pump_id}_dose_ml);
                if (id(${pump_id}_test_mode)) {
                  ESP_LOGI("pump", "ğŸ§ª [Test] Simulation dose Mode 1 Ã  %dh : %.2f ml", current_hour, id(${pump_id}_dose_ml));
                  id(${pump_id}_distributed_today) += id(${pump_id}_dose_ml);
                } else {
                  id(run_${pump_id}_steps).execute();
                }
              }
            }
          }
          // --- Mode 2 : 12 doses par jour (toutes les 2 heures) ---
          else if (mode == 2) {
            if (current_minute == id(${pump_id}_dose_offset_minute) && (current_hour % 2 == 0)) {
              static int last_dose_hour = -1;
              if (current_hour != last_dose_hour) {
                last_dose_hour = current_hour;
                id(${pump_id}_dose_ml) = id(${pump_id}_daily_quantity) / 12.0;
                ESP_LOGD("pump", "Dose toutes les 2h (12 doses) dÃ©clenchÃ©e pour %dh: %.2f ml", current_hour, id(${pump_id}_dose_ml));
                id(${pump_id}_distributed_today) += id(${pump_id}_dose_ml);
                if (id(${pump_id}_test_mode)) {
                  ESP_LOGI("pump", "ğŸ§ª [Test] Simulation dose Mode 2 Ã  %dh : %.2f ml", current_hour, id(${pump_id}_dose_ml));
                  id(${pump_id}_distributed_today) += id(${pump_id}_dose_ml);
                } else {
                  id(run_${pump_id}_steps).execute();
                }
              }
            }
          }
          // --- Mode 3 : PÃ©riodes personnalisÃ©es ---
          else if (mode == 3) {
            const int periods = id(${pump_id}_active_periods);
            int start_hours[6]  = {id(${pump_id}_period1_start_hour), id(${pump_id}_period2_start_hour),
                                   id(${pump_id}_period3_start_hour), id(${pump_id}_period4_start_hour),
                                   id(${pump_id}_period5_start_hour), id(${pump_id}_period6_start_hour)};
            int start_minutes[6] = {id(${pump_id}_period1_start_minute), id(${pump_id}_period2_start_minute),
                                   id(${pump_id}_period3_start_minute), id(${pump_id}_period4_start_minute),
                                   id(${pump_id}_period5_start_minute), id(${pump_id}_period6_start_minute)};
            int end_hours[6]   = {id(${pump_id}_period1_end_hour), id(${pump_id}_period2_end_hour),
                                   id(${pump_id}_period3_end_hour), id(${pump_id}_period4_end_hour),
                                   id(${pump_id}_period5_end_hour), id(${pump_id}_period6_end_hour)};
            int end_minutes[6] = {id(${pump_id}_period1_end_minute), id(${pump_id}_period2_end_minute),
                                   id(${pump_id}_period3_end_minute), id(${pump_id}_period4_end_minute),
                                   id(${pump_id}_period5_end_minute), id(${pump_id}_period6_end_minute)};
            int doses[6]       = {id(${pump_id}_period1_doses), id(${pump_id}_period2_doses),
                                   id(${pump_id}_period3_doses), id(${pump_id}_period4_doses),
                                   id(${pump_id}_period5_doses), id(${pump_id}_period6_doses)};
            bool enabled[6]    = {id(${pump_id}_period1_enabled), id(${pump_id}_period2_enabled),
                                   id(${pump_id}_period3_enabled), id(${pump_id}_period4_enabled),
                                   id(${pump_id}_period5_enabled), id(${pump_id}_period6_enabled)};
            static int last_minute[6] = {-1, -1, -1, -1, -1, -1};

            int now_min = current_hour * 60 + current_minute;

            float total_doses = 0;
            for (int i = 0; i < periods && i < 6; i++) {
              if (enabled[i]) total_doses += doses[i];
            }
            if (total_doses <= 0) return;

            float ml_per_dose = id(${pump_id}_daily_quantity) / total_doses;

            for (int i = 0; i < periods && i < 6; i++) {
              if (!enabled[i]) continue;
              int start = start_hours[i] * 60 + start_minutes[i];
              int end = end_hours[i] * 60 + end_minutes[i];
              int n = doses[i];
              if (n <= 0 || end <= start) continue;
              // Fin de pÃ©riode exclusive pour garantir exactement N doses
              if (now_min >= start && now_min < end) {
                int interval = (end - start) / n;
                if (interval <= 0) interval = 1;
                if (((now_min - start) % interval) == 0 && last_minute[i] != now_min) {
                  last_minute[i] = now_min;
                  id(${pump_id}_dose_ml) = ml_per_dose;
                  ESP_LOGD("pump", "Dose pÃ©riode %d Ã  %02d:%02d : %.2f ml", i + 1, current_hour, current_minute, id(${pump_id}_dose_ml));
                  if (id(${pump_id}_test_mode)) {
                    ESP_LOGI("pump", "ğŸ§ª [Test] Simulation dose Mode 3 pÃ©riode %d", i + 1);
                    id(${pump_id}_distributed_today) += id(${pump_id}_dose_ml);
                  } else {
                    id(run_${pump_id}_steps).execute();
                  }
                }
              }
            }
          }
          // --- Mode 4 : Minuteur (doses individuelles programmÃ©es) ---
          else if (mode == 4) {
            int hours[12]    = {id(${pump_id}_minute_dose_1_hour),  id(${pump_id}_minute_dose_2_hour),
                                id(${pump_id}_minute_dose_3_hour),  id(${pump_id}_minute_dose_4_hour),
                                id(${pump_id}_minute_dose_5_hour),  id(${pump_id}_minute_dose_6_hour),
                                id(${pump_id}_minute_dose_7_hour),  id(${pump_id}_minute_dose_8_hour),
                                id(${pump_id}_minute_dose_9_hour),  id(${pump_id}_minute_dose_10_hour),
                                id(${pump_id}_minute_dose_11_hour), id(${pump_id}_minute_dose_12_hour)};
            int minutes[12]  = {id(${pump_id}_minute_dose_1_minute),  id(${pump_id}_minute_dose_2_minute),
                                id(${pump_id}_minute_dose_3_minute),  id(${pump_id}_minute_dose_4_minute),
                                id(${pump_id}_minute_dose_5_minute),  id(${pump_id}_minute_dose_6_minute),
                                id(${pump_id}_minute_dose_7_minute),  id(${pump_id}_minute_dose_8_minute),
                                id(${pump_id}_minute_dose_9_minute),  id(${pump_id}_minute_dose_10_minute),
                                id(${pump_id}_minute_dose_11_minute), id(${pump_id}_minute_dose_12_minute)};
            float qty[12]    = {id(${pump_id}_minute_dose_1_quantity),  id(${pump_id}_minute_dose_2_quantity),
                                id(${pump_id}_minute_dose_3_quantity),  id(${pump_id}_minute_dose_4_quantity),
                                id(${pump_id}_minute_dose_5_quantity),  id(${pump_id}_minute_dose_6_quantity),
                                id(${pump_id}_minute_dose_7_quantity),  id(${pump_id}_minute_dose_8_quantity),
                                id(${pump_id}_minute_dose_9_quantity),  id(${pump_id}_minute_dose_10_quantity),
                                id(${pump_id}_minute_dose_11_quantity), id(${pump_id}_minute_dose_12_quantity)};
            static int last_day[12] = {-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1};

            for (int i = 0; i < 12; i++) {
              if (current_hour == hours[i] && current_minute == minutes[i] && qty[i] > 0) {
                if (now.day_of_month != last_day[i]) {
                  last_day[i] = now.day_of_month;
                  id(${pump_id}_dose_ml) = qty[i];
                  ESP_LOGD("pump", "Minuteur dose %d: %.2f ml", i + 1, id(${pump_id}_dose_ml));
                  if (id(${pump_id}_test_mode)) {
                    ESP_LOGI("pump", "ğŸ§ª [Test] Simulation dose Mode 4 minuteur %d", i + 1);
                    id(${pump_id}_distributed_today) += id(${pump_id}_dose_ml);
                  } else {
                    id(run_${pump_id}_steps).execute();
                  }
                }
              }
            }
          }
